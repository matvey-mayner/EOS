local a=require("advmath")return{create=function(b,c)local d,e,f,g,h=component.invoke,table.insert,table.concat,unicode.len,unicode.sub;local i,j,k,l,m,n;local o,p,q,r,s,t;local function u(v,w)if not v or not w then v,w=d(b,"getResolution")end;i,j,k,l,m,n={},{},{},{},{},{}o=v;p=w;q,r,s,t=1,1,o,p;for x=1,p do for y=1,o do e(i,0)e(j,0)e(k," ")e(l,0)e(m,0)e(n," ")end end end;u(d(b,"getResolution"))local function z(v,w)d(b,"setResolution",v,w)u(v,w)end;local function A()return o,p end;local function B(y,x)if y>=1 and x>=1 and y<=o and x<=p then local C=o*(x-1)+y;return l[C],m[C],n[C]else return 0,0," "end end;local function D(y,x,E,F,G)for H=1,g(G)do if y>=q and x>=r and y<=s and x<=t then local C=o*(x-1)+y;l[C],m[C],n[C]=E,F,h(G,H,H)end;y=y+1 end end;local function I(y,x,v,w,J,K)local L,C={v,w}for M=x,x+w-1 do for H=y,y+v-1 do if H>=1 and M>=1 and H<=o and M<=p then C=o*(M-1)+H;e(L,l[C])e(L,m[C])e(L,n[C])else e(L,0x0)e(L,0x0)e(L," ")end end end;return L end;local function N(J,K,O,P)local Q=O[1]local R,S,T=o*(K-1)+J,3,o-Q;for x=K,K+O[2]-1 do if x>=r and x<=t then for y=J,J+Q-1 do if y>=q and y<=s then l[R]=O[S]m[R]=O[S+1]n[R]=O[S+2]if P then i[R]=l[R]j[R]=m[R]k[R]=n[R]end end;R,S=R+1,S+3 end;R=R+T else R,S=R+o,S+Q*3 end end end;local function U(y,x,v,w,J,K,P)local V=I(y,x,v,w)N(J,K,V,P)end;local function W(y,x,v,w,E,F,X)local Y;if y<q then v=v-q+y;y=q end;Y=y+v-1;if Y>s then v=v-Y+s end;if x<r then w=w-r+x;x=r end;Y=x+w-1;if Y>t then w=w-Y+t end;Y=o*(x-1)+y;local Z=o-v;for M=1,w do for H=1,v do l[Y],m[Y],n[Y]=E,F,X;Y=Y+1 end;Y=Y+Z end end;local function _(a0)local C,Z,a1=o*(r-1)+q,o-s+q-1,{}local y,a2,a3,a4,a5,a6;local a7,a8,a9,aa,ab;local ac;for x=r,t do y=q;while y<=s do if i[C]~=l[C]or j[C]~=m[C]or k[C]~=n[C]or a0 then a7,a8,a9=l[C],m[C],n[C]i[C]=a7;j[C]=a8;k[C]=a9;a2,a3,a4,a5={a9},2,y+1,C+1;while a4<=s do if a7==l[a5]and(n[a5]==" "or a8==m[a5])then i[a5]=l[a5]j[a5]=m[a5]k[a5]=n[a5]a2[a3],a3=k[a5],a3+1 else break end;a4,a5=a4+1,a5+1 end;aa=a1[a7]or{}a1[a7]=aa;ab=aa[a8]or{index=1}aa[a8]=ab;ac=ab.index;ab[ac],ac=y,ac+1;ab[ac],ac=x,ac+1;ab[ac],ac=f(a2),ac+1;y,C,ab.index=y+a3-2,C+a3-2,ac end;y,C=y+1,C+1 end;C=C+Z end;for E,ad in pairs(a1)do d(b,"setBackground",a.clamp(E,0,c and 15 or 0xFFFFFF),c)for F,ae in pairs(ad)do if a6~=F then d(b,"setForeground",a.clamp(F,0,c and 15 or 0xFFFFFF),c)a6=F end;for H=1,#ae,3 do d(b,"set",ae[H],ae[H+1],ae[H+2])end end end;a1=nil end;return{copy=I,paste=N,move=U,fill=W,setResolution=z,getResolution=A,get=B,set=D,update=_,setUsingTheDefaultPalette=function(af)c=af end}end}